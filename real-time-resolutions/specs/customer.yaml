# Kanoniv Identity Resolution Spec -- Real-Time Example
#
# Used for both the initial batch reconcile and the incremental
# real-time resolve. The spec defines matching rules; the Cloud API
# applies them to the persistent identity graph.

api_version: kanoniv/v2
identity_version: customer_rt_v1

metadata:
  name: Real-Time Customer Resolution
  description: Incremental identity resolution with CDC via Snowflake Streams
  owner: data-engineering
  tags: [real-time, cdc, identity]

entity:
  name: customer
  description: Unified customer entity (3 sources)

sources:
  crm_contacts:
    adapter: snowflake
    location: staging.stg_crm_contacts
    primary_key: external_id
    schema:
      email: { type: string, pii: true }
      phone: { type: string, pii: true }
      first_name: { type: string, pii: true }
      last_name: { type: string, pii: true }
      company_name: { type: string }
    attributes:
      email: email
      phone: phone
      first_name: first_name
      last_name: last_name
      company_name: company_name

  billing_accounts:
    adapter: snowflake
    location: staging.stg_billing_accounts
    primary_key: external_id
    schema:
      email: { type: string, pii: true }
      first_name: { type: string, pii: true }
      last_name: { type: string, pii: true }
      company_name: { type: string }
    attributes:
      email: email
      first_name: first_name
      last_name: last_name
      company_name: company_name

  support_users:
    adapter: snowflake
    location: staging.stg_support_users
    primary_key: external_id
    schema:
      email: { type: string, pii: true, nullable: true }
      phone: { type: string, pii: true, nullable: true }
      first_name: { type: string, pii: true }
      last_name: { type: string, pii: true }
      company_name: { type: string }
    attributes:
      email: email
      phone: phone
      first_name: first_name
      last_name: last_name
      company_name: company_name

blocking:
  strategy: composite
  keys:
    - [email]
    - [phone]
    - [last_name, first_name]
    - [company_name, last_name]

rules:
  - type: exact
    name: email_exact
    field: email
    weight: 1.0

decision:
  scoring:
    strategy: fellegi_sunter
    training:
      method: em
      estimate_u: random_sampling
      max_random_pairs: 500000
      max_iterations: 25
      convergence_threshold: 0.001

    fields:
      - name: email
        comparator: exact
        weight: 2.0
        m_probability: 0.95
        u_probability: 0.001
        normalizer: email

      - name: phone
        comparator: exact
        weight: 1.5
        m_probability: 0.85
        u_probability: 0.005
        normalizer: phone

      - name: first_name
        comparator: jaro_winkler
        weight: 1.0
        m_probability: 0.85
        u_probability: 0.05
        normalizer: nickname

      - name: last_name
        comparator: jaro_winkler
        weight: 1.0
        m_probability: 0.88
        u_probability: 0.02
        normalizer: name

      - name: company_name
        comparator: jaro_winkler
        weight: 1.0
        m_probability: 0.80
        u_probability: 0.02
        normalizer: generic

    thresholds:
      match: 8.0
      possible: 4.0
      non_match: -5.0

  thresholds:
    match: 0.9
    review: 0.7

  conflict_strategy: prefer_high_confidence

survivorship:
  default: source_priority
  overrides:
    - field: email
      strategy: most_complete
    - field: phone
      strategy: source_priority
      priority: [crm_contacts, support_users]
    - field: first_name
      strategy: most_complete
    - field: last_name
      strategy: most_complete
    - field: company_name
      strategy: source_priority
      priority: [crm_contacts, billing_accounts]
